<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper 
    PUBLIC "-//ibatis.apache.org//DTD Mapping 3.0//EN" 
    "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<!-- 
   Code                 varchar(100) not null comment '系统权限代码，编码为数字，具有一定的规律。格式如下：1，11，111，112，12，121，122，13，131，132……',
   RelationPath             varchar(200) comment '关系',
   ParentCode           varchar(100) comment '父权限代码，编码也为数字，格式同上（code）。',
   IndexCode            varchar(200) comment '权限名称,页面使用索引。',
   Name                 varchar(200) comment '权限名称，用2-6个汉字进行规整描述，以方便在页面显示。',
   Type                 char(1) comment '权限类型',
   TreeLevel                varchar(10) comment '此权限是否有效。1：有效 0：无效',
   DataSource           varchar(50) comment '数据源',
   Description          varchar(200) comment '权限描述',
   Controller           varchar(200) comment '控制器对应的url',
   Icon                 varchar(500) comment '功能使用图片',
   CreateTime           datetime comment '创建时间：角色的创建时间，为以后进行跟踪查询。',
   CreatorUserID              varchar(50) comment '创建者：角色创建者姓名的记录。',
   LogOrNot                varchar(100) comment '是否记录日志',
   NavigateOrNot                varchar(100) comment '是否设置导航',
   setAuthOrNot            varchar(100) comment '是否设置子权限',
   SetStatusOrNot             varchar(100) comment '是否记录状态',
-->
<mapper namespace="authorization">

	<parameterMap id="authorization" type="com.sw.core.data.entity.Authorization" />
	<parameterMap id="subAuthorization" type="com.sw.plugins.system.authorization.entity.SubAuthorization" />
	
	<!-- 权限结果集 -->
	<resultMap id="authorizationResult" type="com.sw.core.data.entity.Authorization">
		<result property="code" column="Code" />
		<result property="parentCode" column="ParentCode" />
		<result property="treeLevel" column="TreeLevel" />
		<result property="relationPath" column="RelationPath" />
		<result property="indexCode" column="IndexCode" />
		<result property="name" column="Name" />
		<result property="type" column="Type" />
		<result property="setAuthorityOrNot" column="SetAuthorityOrNot" />
		<result property="description" column="Description" />
		<result property="controller" column="Controller" />
		<result property="pageName" column="PageName" />
		<result property="dataSource" column="DataSource" />
		<result property="icon" column="Icon" />
		<result property="logOrNot" column="LogOrNot" />
		<result property="helpOrNot" column="HelpOrNot" />
		<result property="navigateOrNot" column="NavigateOrNot" />
		<result property="setAuthOrNot" column="SetAuthOrNot" />
		<result property="setStatusOrNot" column="SetStatusOrNot" />
		<result property="createTime" column="CreateTime" />
		<result property="creatorUserId" column="CreatorUserID" />
		<result property="isChildNode" column="IsChildNode"/>
	</resultMap>
	
	
		<!-- 权限结果集 -->
	<resultMap id="subAuthorizationResult" type="com.sw.plugins.system.authorization.entity.SubAuthorization">
		<result property="code" column="Code" />
		<result property="parentCode" column="ParentCode" />
		<result property="tempCode" column="TempCode" />
		<result property="tempParentCode" column="TempParentCode" />
		<result property="treeLevel" column="TreeLevel" />
		<result property="relationPath" column="RelationPath" />
		<result property="indexCode" column="IndexCode" />
		<result property="name" column="Name" />
		<result property="type" column="Type" />
		<result property="setAuthorityOrNot" column="SetAuthorityOrNot" />
		<result property="description" column="Description" />
		<result property="controller" column="Controller" />
		<result property="pageName" column="PageName" />
		<result property="dataSource" column="DataSource" />
		<result property="icon" column="Icon" />
		<result property="logOrNot" column="LogOrNot" />
		<result property="helpOrNot" column="HelpOrNot" />
		<result property="navigateOrNot" column="NavigateOrNot" />
		<result property="setAuthOrNot" column="SetAuthOrNot" />
		<result property="setStatusOrNot" column="SetStatusOrNot" />
		<result property="createTime" column="CreateTime" />
		<result property="creatorUserId" column="CreatorUserID" />
		<result property="businessTypeId" column="BusinessTypeID" />
		<result property="id" column="ID" />
	</resultMap>
	
	<!-- 权限通用查询 -->
	<select id="select" resultMap="authorizationResult" parameterMap="authorization">
		select 
			Code, 
			RelationPath, 
			ParentCode, 
			IndexCode, 
			Name, 
			IsChildNode,
			Type, 
			TreeLevel, 
			DataSource, 
			Description, 
			Controller, 
			Icon, 
			CreateTime, 
			CreatorUserID, 
			LogOrNot, 
			HelpOrNot, 
			NavigateOrNot, 
			SetAuthOrNot,
			SetStatusOrNot,
			PageName
		from SM_Authorization
		<where>
			<trim prefixOverrides="and">
				<if test="treeLevel != null  and treeLevel != '' ">
					and TreeLevel = #{treeLevel}
				</if>
				<if test="code != null and code != '' ">
					and Code = #{code}
				</if>
				<if test="type != null">
					and Type = ${type}
				</if>
				<if test="setAuthorityOrNot != null">
					and SetAuthorityOrNot = #{setAuthorityOrNot}
				</if>
				<if test="parentCode != null and parentCode != '' ">
					and ParentCode = #{parentCode}
				</if>
			</trim>
		</where>
		order by Code
	</select>


	<select id="select_by_code" resultMap="authorizationResult" parameterMap="authorization">
		select 
			Code, 
			RelationPath, 
			ParentCode, 
			IndexCode, 
			Name, 
			IsChildNode,
			Type, 
			TreeLevel, 
			DataSource, 
			Description, 
			Controller, 
			Icon, 
			CreateTime, 
			CreatorUserID, 
			LogOrNot, 
			HelpOrNot, 
			NavigateOrNot, 
			SetAuthOrNot,
			SetStatusOrNot,
			PageName
		from SM_Authorization
		<where>
			<trim prefixOverrides="and">
				<if test="code != null and code != '' ">
					and Code = #{code}
				</if>
				<if test="setAuthorityOrNot != null">
					and SetAuthorityOrNot = #{setAuthorityOrNot}
				</if>
			</trim>
		</where>
		order by Code
	</select>
	
	<select id="select_by_type" resultMap="authorizationResult" parameterMap="authorization">
		select 
			Code, 
			RelationPath, 
			ParentCode, 
			IndexCode, 
			Name, 
			IsChildNode,
			Type, 
			TreeLevel, 
			DataSource, 
			Description, 
			Controller, 
			Icon, 
			CreateTime, 
			CreatorUserID, 
			LogOrNot, 
			HelpOrNot, 
			NavigateOrNot, 
			SetAuthOrNot,
			SetStatusOrNot,
			PageName
		from SM_Authorization
		where Type = 1
		order by Code
	</select>
	
	<select id="select_by_notcodes" resultMap="authorizationResult" parameterMap="authorization">
		select Code
		from   SM_Authorization
		<where>
			<if test=" codes != null">
				Code not in
				<foreach item="cd" index="indexCode" collection="codes" open="(" separator="," close=")">  
	           	 	#{cd}
    			</foreach> 
			</if>
			<if test="type != null">
				and Type = ${type}
			</if>
			<if test="setAuthorityOrNot != null">
				and SetAuthorityOrNot = #{setAuthorityOrNot}
			</if>
		</where>
		order by Code
	</select>
	
	<select id="role_auth_count" resultType="long" parameterMap="authorization">
		select count(*) from SM_RoleAuthMapping
		<where>
			<trim prefixOverrides="and">
				<if test="code != null and code != ''">and AuthCode = #{code}</if>
				<if test="type != null">and Type = ${type}</if>
				<if test="setAuthorityOrNot != null">and SetAuthorityOrNot = #{setAuthorityOrNot}</if>
			</trim>
		</where>
	</select>
	
	<select id="select_auth_business_type_mapping" resultMap="subAuthorizationResult" parameterMap="subAuthorization">
		select *,bam.ID,bam.BusinessTypeID,bam.TempCode,bam.TempParentCode from SM_Authorization auth,SC_BusinessAuthorizationMapping bam,SC_BusinessType bt
	   <where>
	    <trim prefixOverrides="and">
		    (<foreach item="businessType" index="index" collection="businessTypeList" separator="or">
		      bam.BusinessTypeID=${businessType.id}
		    </foreach>)
		    and auth.Code=bam.AuthorizationCode and bt.ID=bam.BusinessTypeID
	    </trim>
	    </where>
	</select>
	

	<!-- 新增权限 -->
	<insert id="insert" parameterMap="authorization">
		insert into SM_Authorization
		<trim prefix="(" prefixOverrides="," suffix=")">
			<if test="code!=null and code != ''">,Code</if>
			<if test="indexCode!=null and indexCode != ''">,IndexCode</if>
			<if test="relationPath!=null and relationPath!=''">,RelationPath</if>
			<if test="parentCode!=null and parentCode!=''">,ParentCode</if>
			<if test="treeLevel!=null and treeLevel!=''">,TreeLevel</if>
			<if test="name!=null and name!=''">,Name</if>
			<if test="isChildNode != null">,IsChildNode</if>
			<if test="type!=null">,Type</if>
			<if test="setAuthorityOrNot !=null ">,SetAuthorityOrNot</if>
			<if test="controller!=null and controller!=''">,Controller</if>
			<if test="logOrNot!=null and logOrNot!=''">,LogOrNot</if>
			<if test="helpOrNot!=null and helpOrNot!=''">,HelpOrNot</if>
			<if test="navigateOrNot!=null and navigateOrNot!=''">,NavigateOrNot</if>
			<if test="setAuthOrNot!=null and setAuthOrNot!=''">,SetAuthOrNot</if>
			<if test="setStatusOrNot!=null and setStatusOrNot!=''">,SetStatusOrNot</if>
			<if test="pageName!=null and pageName!=''">,PageName</if>
			<if test="icon!=null and icon!=''">,Icon</if>
		</trim>
		values
		<trim prefix="(" prefixOverrides="," suffix=")">
			<if test="code!=null and code != ''">,#{code}</if>
			<if test="indexCode!=null and indexCode != ''">,#{indexCode}</if>
			<if test="relationPath!=null and relationPath!=''">,#{relationPath}</if>
			<if test="parentCode!=null and parentCode!=''">,#{parentCode}</if>
			<if test="treeLevel!=null and treeLevel!=''">,#{treeLevel}</if>
			<if test="name!=null and name!=''">,#{name}</if>
			<if test="isChildNode != null">,#{isChildNode}</if>
			<if test="type!=null">,${type}</if>
			<if test="setAuthorityOrNot !=null ">,#{setAuthorityOrNot}</if>
			<if test="controller!=null and controller!=''">,#{controller}</if>
			<if test="logOrNot!=null and logOrNot!=''">,#{logOrNot}</if>
			<if test="helpOrNot!=null and helpOrNot!=''">,#{helpOrNot}</if>
			<if test="navigateOrNot!=null and navigateOrNot!=''">,#{navigateOrNot}</if>
			<if test="setAuthOrNot!=null and setAuthOrNot!=''">,#{setAuthOrNot}</if>
			<if test="setStatusOrNot!=null and setStatusOrNot!=''">,#{setStatusOrNot}</if>
			<if test="pageName!=null and pageName!=''">,#{pageName}</if>
			<if test="icon!=null and icon!=''">,#{icon}</if>
		</trim>
	</insert>

		<!-- 新增权限 -->
	<update id="update" parameterMap="authorization">
		update SM_Authorization
		<set>
			<trim prefixOverrides=",">
			<if test="indexCode!=null and indexCode != ''">,IndexCode=#{indexCode}</if>
			<if test="relationPath!=null and relationPath!=''">,RelationPath=#{relationPath}</if>
			<if test="parentCode!=null and parentCode!=''">,ParentCode=#{parentCode}</if>
			<if test="treeLevel!=null and treeLevel!=''">,TreeLevel=#{treeLevel}</if>
			<if test="name!=null and name!=''">,Name=#{name}</if>
			<if test="isChildNode != null">,IsChildNode = #{isChildNode}</if>
			<if test="type!=null">,Type=${type}</if>
			<if test="setAuthorityOrNot !=null ">,SetAuthorityOrNot = #{setAuthorityOrNot}</if>
			<if test="controller!=null and controller!=''">,Controller=#{controller}</if>
			<if test="logOrNot!=null and logOrNot!=''">,LogOrNot=#{logOrNot}</if>
			<if test="helpOrNot!=null and helpOrNot!=''">,HelpOrNot=#{helpOrNot}</if>
			<if test="navigateOrNot!=null and navigateOrNot!=''">,NavigateOrNot=#{navigateOrNot}</if>
			<if test="setAuthOrNot!=null and setAuthOrNot!=''">,SetAuthOrNot=#{setAuthOrNot}</if>
			<if test="setStatusOrNot!=null and setStatusOrNot!=''">,SetStatusOrNot=#{setStatusOrNot}</if>
			<if test="pageName!=null and pageName!=''">,PageName=#{pageName}</if>
			<if test="icon!=null and icon!=''">,Icon=#{icon}</if>
			</trim>
		</set>
		<where>
			<if test="code!=null and code!=''">
				Code = #{code}
			</if>
		</where>		
	</update>

	<!-- 
	根据CODE删除
	 -->
	<delete id="delete_by_code" parameterMap="authorization">
		delete from
		SM_Authorization where Code = #{code}
	</delete>
	<!-- 
	删除所有数据
	-->	
	<delete id="delete_all" parameterMap="authorization">
		delete from SM_Authorization
	</delete>

	<!-- 
	删除所有数据并重置主键 
	-->
	<delete id="delete_over_key">
		truncate table SM_Authorization
	</delete>

</mapper>
